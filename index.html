<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>reveal.js</title>

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/white.css">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="lib/css/zenburn.css">


    <style>
        .reveal h1 {
            font-size: 3.0em;
        }

        .reveal h2 {
            font-size: 2.4em;
        }

        .reveal h3 {
            font-size: 1.7em;
        }

        .reveal h4 {
            font-size: 1.6em;
        }

        .reveal p {
            font-size: 1.4em;
        }

        .reveal pre code {
            font-size: 1.3em;
            line-height: 1.2;
        }

        .reveal pre {
            width: 100%;
        }
    </style>

    <!-- Printing and PDF exports -->
    <script>
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>
</head>

<body>
    <div class="reveal">
        <div class="slides">

            <!-- BEGIN INTRODUCTION -->

            <section data-background="#F2F2F2">
                <h2>Testing</h2>
                <h3>with</h3>
                <h2>ASP.NET Core</h2>
            </section>

            <!-- BEGIN PROBLEM -->

            <section data-background="#eAeAeA">

                <p>Why should we test code?</p>
                <p>Why should we write testable code?</p>

                <aside class="notes">
                </aside>
            </section>

            <section>
                <p>So we don't end up with 1600 line Winform button clicks.</p>
                <img data-src="assets/20181021_codewinforms.png" height="118" width="1270">
                <p>It happens all the time.</p>

                <aside class="notes">
                    This really happens. And I promise you, 1600 lines is not uncommon.
                </aside>
            </section>


            <section>
                <p>Office layout for software department at my first job out of college.</p>
                <img data-src="assets/20181021_officelayout.png" height="972" width="1728">

                <aside class="notes">
                    But first, a story. About my first software job.
                    <br /> I sat in a cubicle and wrote code all day, and I didn't talk to anyone around me, because
                    that would decrease productivity.
                    <br /> And I wore khakis, a dress shirt, and sometimes a tie.
                </aside>
            </section>

            <section>
                <p>This was typical.</p>
                <pre class="visualbasic"><code style="max-height:100%" data-trim data-noescape>    Private Sub btnOrderCreate_Click(sender As object, e As EventArgs) Handles btnOrderCreate.Click
        ...

        If ExecuteSQLInt("SELECT FeatureFlag1 FROM AR_MASTER WHERE AR_ACCT_ID = " + txtBoxAcct1.Text) = 1
            And ExecuteSql("UPDATE HR_User Set LastAction = GETDATE() WHERE User_ID = " + txtBoxRep.Text)
            And ExecuteSqlString("SELECT PIN FROM HR_USER WHERE User_ID = " + txtBoxRepId.Text) = inputRepPass.Value
            Then
            ...
            ' Create Order
        ElseIf something or other Then
            ...
        Else
            ...
        End If
        ...
    End Sub</code></pre>
                <p>This happened over 12 years.</p>
                <aside class="notes">
                    This code is paraphrasing, and is meant to illustrate the intent and reality.
                    <br /> And the reality is a giant winforms application.
                </aside>
            </section>

            <section>
                <p>Testing this code was a very manual, tedious, and inprecise process.
                    <br /> I haven't listed the other 20,000 lines in this one file.</p>
                <img data-src="assets/winforms_testing.gif" height="548" width="960">
                <p> Did I mention there are hundreds of forms?</p>
                <aside class="notes">
                </aside>
            </section>


            <!-- BEGIN Dependency inversion -->

            <section data-background="#eAeAeA">
                <p>The code was too complicated and no separation of concerns made unit tests near impossible.</p>
                <ul>
                    <li>The "Business logic" shouldn't be completely dependent on the GUI.</li>
                    <li>The "Business logic" should probably be a little clearer on how and why it's calling the
                        database.</li>
                </ul>
                <aside class="notes">
                    One test at a time is always the best place to start, but we were given no time, and none of us had
                    ever done it before.
                </aside>
            </section>

            <section>
                <h2>Dependency Inversion Principle</h2>
                <br />

                <p>High-level modules should not depend on low-level modules. Both should depend on abstractions.
                    <br />
                    <br /> Abstractions should not depend on details. Details should depend on abstractions.
                </p>
                <aside class="notes">
                    Might be a good time to remind y'all where I'm going with this.
                    <br /> And it's not ASP.NET Core specific!
                </aside>
            </section>

            <section>
                <p>Now might be a good time to spoil the ending to the concepts here.
                    <br />
                    <br /> Dependency injection by adding ASP.NET Core Services.</p>
                <pre class="csharp"><code style="max-height:100%" data-trim data-noescape>    // This method gets called by the runtime. Use this method to add services to the container.
    public void ConfigureServices(IServiceCollection services)
    {
        services.AddMvc().SetCompatibilityVersion(CompatibilityVersion.Version_2_1);
        services.AddSingleton&lt;ICacheResults, InMemoryCache&gt;();
    }</code></pre>
                <aside class="notes">
                    This is in the Startup.cs class, which comes with every ASP.NET Core class
                </aside>
            </section>

            <!-- BEGIN Story part 2 -->

            <section>
                <p>One day I walked into work after a late night deployment of a major software update...</p>
                <img data-src="assets/flame-war.gif" height="692" width="680">

                <aside class="notes">
                    Sounds like the beginning of a joke where "the software developer walked into a bar".
                    <br />Anyway, stuff was broke.
                </aside>
            </section>

            <section>
                <p>A LOT of work had been done in this file, and we knew something was breaking in this 3000 line
                    button click based on pictures from the client.</p>
                <pre class="visualbasic"><code style="max-height:100%" data-trim data-noescape>    Private Sub btnOrderCreate_Click(sender As object, e As EventArgs) Handles btnOrderCreate.Click
            ...

            If ExecuteSQLInt("SELECT FeatureFlag1 FROM AR_MASTER WHERE AR_ACCT_ID = " + txtBoxAcct1.Text) = 1
                And ExecuteSql("UPDATE HR_User Set LastAction = GETDATE() WHERE User_ID = " + txtBoxRep.Text)
                And ExecuteSqlString("SELECT PIN FROM HR_USER WHERE User_ID = " + txtBoxRepId.Text) = inputRepPass.Value
                Then
                ...
                ' Create Order
            ElseIf something or other Then
                ...
            Else
                ...
            End If
            ...
        End Sub</code></pre>
                <aside class="notes">
                    We couldn't get access to the client's environment.
                </aside>
            </section>

            <section>
                <p>When a client can't take orders, that's the most important problem.</p>
                <ul>
                    <li>The client gets angry.</li>
                    <li>Your employer looks bad.</li>
                    <li>You better be confident in any proposed fix you bring
                        <br /> to your boss, for them to bring to the client.</li>
                    <li>How can you even diagnose the problem with no information on their setup?</li>
                </ul>
                <aside class="notes">
                </aside>
            </section>

            <section>
                <p>How can I find the problem?
                    <br />
                    <br />I need to run the code by stepping through the code and debugging it and guessing.
                </p>
                <aside class="notes">
                </aside>
            </section>

            <section>
                <p>Is it safe to run the code? </p>
                <ul>
                    <li>Can I be sure that real services won't accidentally be called?</li>
                    <li>Can I isolate and dismiss chunks of code?</li>
                </ul>
                <aside class="notes">
                    All the time I hear software developers boast about their debugging skills, how they can take some
                    code, break it down, and find what's wrong.
                    <br /> I even see it on job listings that strong debugging skills are desired.
                </aside>
            </section>

            <section>
                <p>The same skills you use to debug software, is the same skills you use to refactor code to write
                    tests for the code.</p>
                <img data-src="assets/insane_macho.gif" height="600" width="804">

                <aside class="notes">
                    Understanding code usually follows the same methods of reading and breaking down code.
                    <br /> What changes, is what you do with that understanding, whether you write tests or just debug
                    the problem and let the code continue to be a problem.

                </aside>
            </section>

            <!-- BEGIN DEBUGGING CLAIMS -->

            <section data-background="#eAeAeA">
                <p>Enough of my problems for a bit, here's the software I want to write tests for.</p>
                <img data-src="assets/meetup_api.png" height="525" width="1113">
                <br />
                <img data-src="assets/meetup_api2.png" height="280" width="1113">
                <aside class="notes">
                    The first window displays past events for a meetup.
                    <br />The second window displays up to the most recent 10 meetup event searches.
                </aside>
            </section>

            <section>
                <img data-src="assets/meetup_api2.png" height="280" width="1113">
                <pre class="chsarp"><code style="max-height:100%" data-trim data-noescape>     // GET api/meetup
        [HttpGet()]
        public IEnumerable&lt;string&gt; Get()
        {
            return this.searchRankings.GetRecentSearchResults();
        }</code></pre>
                <aside class="notes">
                    This second window is great. It's a joy to test, it's so simple.
                </aside>
            </section>

            <section>
                <img data-src="assets/meetup_api.png" height="350" width="742">
                <pre class="chsarp"><code style="max-height:100%" data-trim data-noescape>// GET api/meetup/knox-net
[HttpGet("{name}")]
public async Task&lt;IEnumerable&lt;string&gt;&gt; Get(string name)
{
    if(string.IsNullOrWhiteSpace(name)) {
        return new string[0];
    }

    this.searchRankings.AddRecentSearch(name);
    HttpResponseMessage response = await httpClient.GetAsync($"{name}/events?key={this.meetupApiKey}&status=past");
    var events = await response.Content.ReadAsAsync&lt;List&lt;MeetupEvent&gt;&gt;();
    return events.Select(x => x.name);
}</code></pre>
                <aside class="notes">
                    This second window is great. It's a joy to test, it's so simple.
                </aside>
            </section>

            <section>
                <h3>API Controller constructor</h3>
                <pre class="chsarp"><code style="max-height:100%" data-trim data-noescape>    private readonly string meetupApiKey;
    private readonly HttpClient httpClient;
    private readonly ICacheResults searchRankings;

    public MeetupController(IConfiguration configuration, ICacheResults searchRankings)
    {
        meetupApiKey = configuration.GetValue&lt;string&gt;("MEETUP_API_KEY");
        httpClient = new HttpClient() {
            BaseAddress = new Uri("https://api.meetup.com/")
        };
        httpClient.DefaultRequestHeaders.Accept.Clear();
        httpClient.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));
        this.searchRankings = searchRankings;
    }</code></pre>
                <p>https://dev.azure.com/knoxdevops/knoxdevops</p>
                <aside class="notes">
                    Honestly, this isn't the worst constructor. It's still very manageable.
                </aside>
            </section>

            <!-- BEGIN OUTRO -->

            <section data-background="#eAeAeA">
                <p>The problems with testing this code.</p>
                <ul>
                    <li>Any tests directly call the Meetup API.</li>
                    <li>The data returned from the API changes over time.</li>
                    <li>This API is Meetup Production, what if I'm making changes to events with a PUT or POST?</li>
                    <li>This code could be copy-pasted to elsewhere.</li>
                </ul>
                <br/>
                <p>Note: I'm ignoring the argument whether API controllers should be tested, this depends on company and team.</p>
                <aside class="notes">

                </aside>
            </section>

            <!-- BEGIN OUTRO -->

            <section data-background="#333333">
                <h1>Daniel Oliver</h1>
                <p>Microsoft MVP</p>
                <p>Website: olivercoding.com</p>
                <p>Twitter: @a_software_dev</p>
                <p>Github: danieloliver</p>
                <p>Slides: https://dotnet-testing-talk.olivercoding.com/</p>
                <img style="background-color: rgba(255, 255, 255, 0); border:none; box-shadow: 0 0 0 rgba(0,0,0,0);"
                    data-src="assets/Asset_7.png">
                <aside class="notes">
                    Radio Systems Corporation of Knoxville is my employer. I focus on solutions.
                </aside>
            </section>

        </div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>
        // More info about config & dependencies:
        // - https://github.com/hakimel/reveal.js#configuration
        // - https://github.com/hakimel/reveal.js#dependencies
        Reveal.initialize({
            width: 1920,
            height: 1080,
            margin: 0.1,
            minScale: 0.2,
            maxScale: 4.0,
            dependencies: [
                { src: 'plugin/markdown/marked.js' },
                { src: 'plugin/markdown/markdown.js' },
                { src: 'plugin/notes/notes.js', async: true },
                { src: 'plugin/highlight/highlight.js', async: true, callback: function () { hljs.initHighlightingOnLoad(); } }
            ]
        });
        Reveal.configure({
            showSlideNumber: 'speaker',
            slideNumber: true,
            slideNumber: 'c/t'
        });
    </script>
</body>

</html>